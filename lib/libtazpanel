#!/bin/sh
#
# Common functions for TazPanel CGI and cmdline interface
#

[ "$(id -un)" == "$REMOTE_USER" ] || exec su -c "$(realpath $0) $@" $REMOTE_USER

# Get parameters with GET, POST and FILE functions
. /usr/lib/slitaz/httphelper

# I18n
. /etc/locale.conf
. /usr/bin/gettext.sh
TEXTDOMAIN='tazpanel'
export TEXTDOMAIN LANG LC_ALL

# We need a config file first
get_config() {
	CONFIG="/etc/slitaz/tazpanel.conf"
	[ -f data/tazpanel.conf ] && CONFIG="data/tazpanel.conf"
	[ -f "$CONFIG" ] && . $CONFIG
	[ ! -f "$PANEL/lib/libtazpanel" ] && \
		echo "No config file or libtazpanel found: $CONFIG" && \
		exit 1
}

# Display < > &
htmlize() {
	sed -e 's|\&|\&amp;|g; s|<|\&lt;|g; s|>|\&gt;|g'
}

# Syntax highlighting for config file and SHell scripts
syntax_highlighter() {
	case $1 in
		conf)
			htmlize | sed \
				-e s"#^\#\([^']*\)#<span class='conf-comment'>\0</span>#"g \
				-e s"#^[A-Z]\([^']*\)=#<span class='conf-var'>\0</span>#"g \
				-e s"#^[a-z]\([^']*\)#<span class='conf-var'>\0</span>#"g \
				-e s"#\"\([^']*\)\"#<span class='conf-val'>\0</span>#"g ;;
		sh)
			htmlize | sed \
				-e s"#^\#\([^']*\)#<span class='sh-comment'>\0</span>#"g \
				-e s"#\"\([^']*\)\"#<span class='sh-val'>\0</span>#"g ;;
		diff)
			htmlize | sed \
				-e s"#^-\(.*\).#<span class='diff-rm'>\0</span>#"g \
				-e s"#^+\(.*\).#<span class='diff-add'>\0</span>#"g \
				-e s"#@@\(.*\)@@#<span class='diff-at'>@@\1@@</span>#"g ;;
		activity)
			sed -e s"#^\([^']*:\)#<span class='activity-log'>\0</span>#"g ;;
		kernel)
			htmlize | sed \
				-e "s|\([^0-9]\)\(0x[0-9a-f]\+\)|\1<span class='kernel-hex'>\2</span>|g" \
				-e "s|^\([^(,\[]\+: \)|<span class='kernel-id'>\0</span>|g" \
				-e "s|\(\[[^ ]\+\]\)|<span class='kernel-id2'>\0</span>|g" ;;
		lsusb)
			htmlize | sed \
				-e 's|^[^:]*:[ x0-9a-f^:]*$|<span class="lsusb-t">\0</span>|g' \
				-e 's|^Bus.*$|<span class="lsusb-h">\0</span>|g' ;;
		lspci)
			htmlize | sed \
				-e 's|^[0-9a-f].*$|<span class="lspci-t">\0</span>|g' \
				-e 's|^	\([^:]*:\)|	<span class="lspci-h">\1</span>|g' ;;

	esac
}

# Remove status and ESC char from tazpkg/tazlito commands output
filter_taztools_msgs() {
	sed	-e s'/\[^Gm]*.//g' \
		-e ':a;s/^\(.\{1,68\}\)\(\[ [A-Za-z]* \]\)/\1 \2/;ta' \
		-e 's#\[ OK \]#[ <span class="diff-add">OK</span> ]#' \
		-e 's#\[ Failed \]#[ <span class="diff-rm">Failed</span> ]#'
}

# LOG activities
log() {
	date=$(date "+%Y-%m-%d %H:%M")
	filter_taztools_msgs | \
	sed s"#[^']*#$date : \0#" >> $LOG_FILE
}

ok_status() {
	echo "[<span class='diff-add'> OK </span>]"
}

# Network interface status
interface_status() {
	if 	ifconfig | grep -A 1 $i | grep -q inet; then
		ip=`ifconfig | grep -A 1 $i | grep inet | \
			awk '{ print $2 }' | cut -d ":" -f 2`
		echo "<td>$(gettext 'connected')</td><td>$ip</td>"
		echo "<td><a href='/network.cgi?scan=$ip'>"
		echo "<img src='$IMAGES/recharge.png' /></a></td>"
	else
		echo "<td>----</td><td>----</td><td></td>"
	fi
}

# Catch network interface (used in summary and network main page)
list_network_interfaces() {
	cat << EOT
<table class="zebra outbox">
	<thead>
		<tr>
			<td>$(gettext 'Interface')</td>
			<td>$(gettext 'Name')</td>
			<td>$(gettext 'Status')</td>
			<td>$(gettext 'IP Address')</td>
			<td>$(gettext 'Scan ports')</td>
		</tr>
	</thead>
	<tbody>
EOT
	for i in `ls /sys/class/net`
	do
		case $i in
			eth*)
				echo "		<tr><td><a href='/network.cgi?eth'>
					<img src='$IMAGES/ethernet.png' />$i</a></td>
					<td>Ethernet</td> $(interface_status)</tr>" ;;
			wlan*|ath*|ra*)
				echo "		<tr><td><a href='/network.cgi?wifi'>
					<img src='$IMAGES/wireless.png' />$i</a></td>
					<td>Wireless</td> $(interface_status)</tr>" ;;
			lo)
				echo "		<tr><td><img src='$IMAGES/loopback.png' />$i</td>
				<td>Loopback</td> $(interface_status)</tr>" ;;
			*)
				continue ;;
		esac
	done
	cat << EOT
	</tbody>
</table>
EOT
}

# Get the list of panel styles
list_styles() {
	for style in $PANEL/styles/*
	do
		style=$(basename $style)
		echo "<option value='$style'>$style</option>"
	done
}

# Get the list of system locales
list_locales() {
	for locale in $(find /usr/share/i18n/locales -type f -name "[a-z][a-z]_[A-Z][A-Z]")
	do
		echo "<option value='$locale'>$locale</option>"
	done
}

# Get the list of console keymaps
list_keymaps() {
	for keymap in /usr/share/kmap/*.kmap
	do
		basename $keymap .kmap | sed "s|.*|<option value='&'>&</option>|"
	done
}

#
# xHTML 5 (header and footer skel are from the style)
#

loading_msg() {
	cat << EOT
<script type="text/javascript">
	document.write('<div id="loading"><img src="/styles/default/images/loader.gif" />$LOADING_MSG</div>');
</script>
EOT
}

xhtml_header() {
	. ${PANEL}$HEADER
	if [ $DEBUG == "1" ]; then
		local i
		local j
		local x
		args=""
		for x in GET POST COOKIE ; do
			for i in $($x) ; do
				if [ $($x $i count) -gt 1 ]; then
					for j in $(seq 1 $($x $i count)); do
						args="$args $x($i,$j)='$($x $i $j)'"
					done
				else
					args="$args $x($i)='$($x $i)'"
				fi
			done
		done
		for i in $(FILE); do
			for j in name size type tmpname ; do
				args="$args FILE($i,$j)=$(FILE $i $j)"
			done
		done
		cat << EOT
<pre class='debug'>
QUERY_STRING="$QUERY_STRING"$args
</pre>
EOT
	fi
}

xhtml_footer() {
	. ${PANEL}$FOOTER
}

table_start() {
	echo '<table>'
}

table_end() {
	echo '</table>'
}

df_thead() {
	cat << EOT
<thead>
	<tr>
		<td>$(gettext 'Disk')</td>
		<td>$(gettext 'Label')</td>
		<td>$(gettext 'Type')</td>
		<td>$(gettext 'Size')</td>
		<td>$(gettext 'Available')</td>
		<td>$(gettext 'Used')</td>
		<td>$(gettext 'Mount point')</td>
		<td>UUID</td>
	</tr>
</thead>
EOT
}

msg() {
	msgtype="$1"; shift
	case "$msgtype" in
		tip)			MSG_ICON="$IMAGES/msg-tip.png" ;;
		warn|warning)	MSG_ICON="$IMAGES/msg-warn.png" ;;
		err|error)		MSG_ICON="$IMAGES/msg-err.png" ;;
		up)				MSG_ICON="$IMAGES/msg-up.png" ;;
		*)				MSG_ICON="$IMAGES/msg.png" ;;
	esac
	cat << EOT
	<section class="box" style="width:50%;margin:0.5em auto;">
		<image src="$MSG_ICON" alt="$msgtype" class="float-left" />
		$@
	</section>
EOT
}

is_installed() {
	[ -d "$INSTALLED/$1" ]
}

blk2h() {
	echo $1 | awk '{
	n = $0/2
	for (i = 1; n > 1024; i++)
		n /= 1024
	f = "%1.0f%c"
	if (n < 100)
		f = "%1.1f%c"
	printf f,n,substr("KMGT", i, 1)
}'
}

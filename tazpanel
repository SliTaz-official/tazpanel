#!/bin/sh
#
# Tiny Tazpanel cmdline interface
#
# Copyright (C) 2012-2015 SliTaz GNU/Linux - BSD License
#
VERSION=1.8.2


# Get the configuration file and functions

CONFIG="/etc/slitaz/tazpanel.conf"
[ -f "$CONFIG" ] && . $CONFIG
[ -f "data/tazpanel.conf" ] && . data/tazpanel.conf
[ ! "$PANEL" ] && echo "No config file found: $CONFIG" && exit 1

. /lib/libtaz.sh


# I18n

TEXTDOMAIN='tazpanel'
export TEXTDOMAIN


#
# Commands
#

NAME=tazpanel
DESC="SliTaz administration and configuration panel."
DAEMON=/usr/sbin/httpd
PIDFILE=/run/$NAME.pid

case "$1" in
	-h|*help|*usage)
		echo
		gettext 'Usage: tazpanel [start|stop|passwd|app]'; echo
		echo ;;
	start)
		if [ -f $PIDFILE ]; then
			gettext 'TazPanel is already running.'; echo
			exit 1
		fi
		eval_gettext 'Starting TazPanel web server on port $HTTPD_PORT...'
		httpd -p $HTTPD_PORT -u root -c $HTTPD_CONF \
			-r "$(gettext 'TazPanel Authentication - Default: root:root')" &
		ps | grep "httpd -p $HTTPD_PORT " | grep -v grep | \
			awk '{ print $1 }' > $PIDFILE
		[ ! -f /var/lib/tazpkg/installed.info ] && tazpkg -l>/dev/null&
		status ;;
	stop)
		if [ ! -f $PIDFILE ]; then
			gettext 'TazPanel is not running.'; echo
			exit 1
		fi
		gettext 'Stopping TazPanel web server...'
		kill $(pgrep -f TazPanel)
		rm -f $PIDFILE
		status ;;
	passwd|-p)
		echo
		gettext 'Changing password for TazPanel'; echo
		gettext 'New password: ' && read pass
		sed -i "s/\/:root:.*/\/:root:$pass/" $HTTPD_CONF
		gettext 'Password changed successfully'; echo
		echo ;;
	*)
		. /etc/slitaz/applications.conf
		USER_CONFIG="$HOME/.config/slitaz/applications.conf"
		[ -f "$USER_CONFIG" ] && . $USER_CONFIG
		[ -n "$1" ] && app="/${1}.cgi"
		echo http://localhost:82${app}
		case "$BROWSER" in
			tazweb) tazweb --notoolbar http://localhost:82${app} & ;;
			midori) midori --app=http://localhost:82${app} & ;;
			*) $BROWSER http://localhost:82${app} & ;;
		esac ;;
esac

exit 0
